{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Analytics por país" %}{% endblock %}

{% block content %}
<div class="container py-4" style="max-width:1200px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">{% trans "Analytics por país" %}</h1>
  </div>

  {% if allowed_countries and allowed_countries|length > 0 %}

  <!-- Filtros superiores -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <form id="filters" class="row g-3 align-items-end">

        <!-- País -->
        <div class="col-12 col-md-4">
          <label class="form-label">{% trans "País" %}</label>
          {% if allowed_countries|length == 1 %}
            <input type="hidden" id="pais" value="{{ default_country_id }}">
            <div class="form-control bg-light">{{ allowed_countries.0.nombre }}</div>
          {% else %}
            <select id="pais" class="form-select">
              {% for p in allowed_countries %}
                <option value="{{ p.id }}" {% if p.id == default_country_id %}selected{% endif %}>
                  {{ p.nombre }}
                </option>
              {% endfor %}
            </select>
          {% endif %}
        </div>

        <!-- Rango de fechas -->
        <div class="col-6 col-md-2">
          <label class="form-label">{% trans "Desde" %}</label>
          <input id="from" type="date" class="form-control" value="{{ default_from }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">{% trans "Hasta" %}</label>
          <input id="to" type="date" class="form-control" value="{{ default_to }}">
        </div>

        <!-- Granularidad -->
        <div class="col-6 col-md-2">
          <label class="form-label">{% trans "Granularidad" %}</label>
          <select id="granularity" class="form-select">
            <option value="day"   {% if default_granularity == 'day' %}selected{% endif %}>{% trans "Día" %}</option>
            <option value="month" {% if default_granularity == 'month' %}selected{% endif %}>{% trans "Mes" %}</option>
            <option value="year"  {% if default_granularity == 'year' %}selected{% endif %}>{% trans "Año" %}</option>
          </select>
        </div>

        <div class="col-12 col-md-2 d-grid">
          <button id="apply" type="button" class="btn btn-primary">{% trans "Aplicar" %}</button>
        </div>

        <!-- Presets -->
        <div class="col-12">
          <div class="btn-group btn-group-sm" role="group" aria-label="presets">
            <button type="button" class="btn btn-outline-secondary" data-preset="today">{% trans "Hoy" %}</button>
            <button type="button" class="btn btn-outline-secondary" data-preset="7d">{% trans "Últimos 7 días" %}</button>
            <button type="button" class="btn btn-outline-secondary" data-preset="30d">{% trans "Últimos 30 días" %}</button>
            <button type="button" class="btn btn-outline-secondary" data-preset="mtd">MTD</button>
            <button type="button" class="btn btn-outline-secondary" data-preset="ytd">YTD</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3" id="kpi-row">
    <div class="col-12 col-md-4">
      <div class="card kpi-card border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted small">{% trans "Reservas" %}</div>
            <div class="fs-3 fw-bold" id="kpi-reservas">—</div>
          </div>
          <i class="bi bi-calendar-check fs-2 text-muted"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card kpi-card border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted small">{% trans "Sucursales" %}</div>
            <div class="fs-3 fw-bold" id="kpi-suc">—</div>
          </div>
          <i class="bi bi-shop fs-2 text-muted"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card kpi-card border-0 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted small">{% trans "Admins de sucursal" %}</div>
            <div class="fs-3 fw-bold" id="kpi-badmins">—</div>
          </div>
          <i class="bi bi-person-gear fs-2 text-muted"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficas -->
  <div class="row g-3">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h6 class="text-muted mb-2">{% trans "Reservas a lo largo del tiempo" %}</h6>
          <div class="ratio ratio-21x9"><canvas id="chart-series"></canvas></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h6 class="text-muted mb-2">{% trans "Horas pico" %}</h6>
          <div class="ratio ratio-21x9"><canvas id="chart-hours"></canvas></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h6 class="text-muted mb-2">{% trans "Tamaño de mesa" %}</h6>
          <div class="ratio ratio-21x9"><canvas id="chart-party"></canvas></div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h6 class="text-muted mb-2">{% trans "Top sucursales" %}</h6>
          <div class="ratio ratio-21x9"><canvas id="chart-branches"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======= COMPARAR SUCURSALES (selector múltiple ID — Nombre) ======= -->
  <div class="card border-0 shadow-sm mt-4" id="cmp-card">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="text-muted mb-0">{% trans "Comparar sucursales" %}</h6>
        <div id="cmp-loader" class="spinner-border spinner-border-sm text-secondary d-none" role="status"></div>
      </div>

      <!-- Filtros del comparador -->
      <div class="row g-3">
        <!-- Selector múltiple por país -->
        <div class="col-12 col-lg-4">
          <label class="form-label">{% trans "Sucursales (selección múltiple)" %}</label>
          <select id="cmp-branches" class="form-select" multiple size="7">
            <!-- se llena vía JS con:  id — nombre -->
          </select>
          <div class="form-text">
            {% trans "Mantén Ctrl (Windows) o Cmd (Mac) para múltiples. Vacío = todas las sucursales del país." %}
          </div>
        </div>

        <div class="col-6 col-lg-2">
          <label class="form-label">{% trans "Hora desde" %}</label>
          <input id="cmp-hour-from" type="number" min="0" max="23" value="8" class="form-control">
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">{% trans "Hora hasta" %}</label>
          <input id="cmp-hour-to" type="number" min="0" max="23" value="22" class="form-control">
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">{% trans "Capacidad mínima" %}</label>
          <input id="cmp-cap-min" type="number" min="1" value="1" class="form-control">
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">{% trans "Capacidad máxima" %}</label>
          <input id="cmp-cap-max" type="number" min="1" value="12" class="form-control">
        </div>

        <div class="col-12">
          <label class="form-label d-block mb-1">{% trans "Estados" %}</label>
          <div class="d-flex gap-3 flex-wrap">
            <div><input id="cmp-st-conf" class="form-check-input" type="checkbox" checked> <label for="cmp-st-conf" class="form-check-label">CONF</label></div>
            <div><input id="cmp-st-pend" class="form-check-input" type="checkbox" checked> <label for="cmp-st-pend" class="form-check-label">PEND</label></div>
            <div><input id="cmp-st-canc" class="form-check-input" type="checkbox"> <label for="cmp-st-canc" class="form-check-label">CANC</label></div>
            <div><input id="cmp-st-nosh" class="form-check-input" type="checkbox"> <label for="cmp-st-nosh" class="form-check-label">NOSH</label></div>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <button id="cmp-run" type="button" class="btn btn-outline-primary btn-sm">{% trans "Comparar" %}</button>
      </div>

      <!-- Tabla de comparación -->
      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>{% trans "Sucursal" %}</th>
              <th class="text-end">{% trans "Total" %}</th>
              <th class="text-end">{% trans "Confirmadas" %}</th>
              <th class="text-end">{% trans "Canceladas" %}</th>
              <th class="text-end">{% trans "No show" %}</th>
              <th class="text-end">{% trans "Pendientes" %}</th>
              <th class="text-end">{% trans "Avg. pax" %}</th>
              <th class="text-end">{% trans "# Mesas usadas" %}</th>
            </tr>
          </thead>
          <tbody id="cmp-tbody"><!-- filas dinámicas --></tbody>
        </table>
      </div>
    </div>
  </div>

  {% else %}
    <div class="alert alert-warning">
      {% trans "No tienes países asignados para ver analytics." %}
    </div>
  {% endif %}
</div>

<link rel="stylesheet" href="{% static 'reservas/css/analytics.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="{% static 'reservas/js/analytics.js' %}"></script>
{% endblock %}
