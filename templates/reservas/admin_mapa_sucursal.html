{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Mapa" %} | {{ sucursal.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'reservas/css/mapa.css' %}">
<link rel="stylesheet" href="{% static 'reservas/css/bloqueos.css' %}">
<link rel="stylesheet" href="{% static 'reservas/css/ordenes.css' %}">
{% endblock %}

{% block content %}
<div class="container py-3">

  <nav class="breadcrumb-lite" aria-label="{% trans 'breadcrumb' %}">
    <a href="{% url 'reservas:admin_sucursales' %}">{% trans "Sucursales" %}</a> /
    <span>{{ sucursal.nombre }}</span>
  </nav>

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="page-title mb-1">{% trans "Mapa de mesas" %}</h1>
      <p class="small-muted m-0">
        {% trans "Administra tus mesas, bloquea horarios y revisa estado." %}
      </p>
    </div>

    <div class="d-flex gap-2 align-items-center">

      <div class="btn-group me-2" role="group">
        <button type="button" class="btn btn-light btn-sm" data-zone-filter="">{% trans "Todas" %}</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" data-zone-filter="interior">{% trans "Interior" %}</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" data-zone-filter="terraza">{% trans "Terraza" %}</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" data-zone-filter="exterior">{% trans "Exterior" %}</button>
      </div>

      <button id="btnDesignLock" class="btn btn-link text-muted" data-sucursal-id="{{ sucursal.id }}">
        <i class="bi bi-unlock"></i>
        <span data-lock-text>{% trans "Dise√±o editable" %}</span>
      </button>

      <!-- Nueva mesa (sigue igual) -->
      <button class="btn btn-primary btn-round" data-bs-toggle="modal" data-bs-target="#modalCreateMesa">
        <i class="bi bi-plus-lg"></i> {% trans "Nueva mesa" %}
      </button>

      <a class="btn btn-outline-secondary btn-round" href="{% url 'reservas:admin_buscar_folio' %}">
        <i class="bi bi-search"></i> {% trans "Buscar folio" %}
      </a>

      <!-- Bloquear horarios sucursal -->
      <button class="btn btn-outline-dark btn-round"
              data-bloqueo-sucursal
              data-sucursal-id="{{ sucursal.id }}"
              data-bs-toggle="modal"
              data-bs-target="#modalBloqueo">
        <i class="bi bi-calendar-x"></i> {% trans "Bloquear horarios (sucursal)" %}
      </button>

      <!-- Ver bloqueos sucursal -->
      <button class="btn btn-outline-secondary btn-round"
              data-ver-bloqueos
              data-sucursal-id="{{ sucursal.id }}"
              data-bs-toggle="modal"
              data-bs-target="#modalBloqueosLista">
        <i class="bi bi-eye"></i> {% trans "Ver bloqueos (sucursal)" %}
      </button>

      <a class="btn btn-outline-success btn-round" href="{% url 'reservas:kds' %}">
        üë®‚Äçüç≥ {% trans "Cocina (KDS)" %}
      </a>
    </div>
  </div>

  <ul class="list-inline small text-muted mb-2 map-legend">
    <li class="list-inline-item"><span class="legend-dot legend-interior"></span> {% trans "Interior" %}</li>
    <li class="list-inline-item"><span class="legend-dot legend-terraza"></span> {% trans "Terraza" %}</li>
    <li class="list-inline-item"><span class="legend-dot legend-exterior"></span> {% trans "Exterior" %}</li>
    <li class="list-inline-item"><span class="legend-dot legend-recepcion"></span> {% trans "Recepci√≥n" %}</li>
  </ul>

  <div id="mapCanvas"
       class="map-canvas"
       data-editable="1"
       data-api-list="{{ api_list_url }}"
       data-api-save="{{ api_save_url }}"
       aria-label="{% trans 'Mapa de mesas arrastrable' %}">

    {% with rx=sucursal.recepcion_x|default_if_none:3 ry=sucursal.recepcion_y|default_if_none:3 %}
      <div id="recepcionNode"
           class="recepcion-node"
           role="button"
           tabindex="0"
           aria-label="{% trans 'Recepci√≥n' %}"
           data-update-url="{% url 'reservas:admin_api_recepcion_pos' sucursal.id %}"
           data-x="{{ rx|floatformat:2 }}"
           data-y="{{ ry|floatformat:2 }}"
           style="left: {{ rx }}%; top: {{ ry }}%;">
        üõéÔ∏è {% trans "Recepci√≥n" %}
      </div>
    {% endwith %}

    {% for item in estado_mesas %}
      {% with m=item.mesa est=item.estado reservas=item.reservas %}
        {% with nx=m.pos_x|default_if_none:8 ny=m.pos_y|default_if_none:8 %}

          <div class="mesa-node mesa-zona-{{ m.zona|default:'interior' }}"
               role="button"
               tabindex="0"
               title="{% trans 'Doble clic para acciones' %}"
               aria-label="Mesa {{ m.numero }}"
               data-update-url="{% url 'reservas:admin_api_mesa_pos' m.id %}"
               data-x="{{ nx|floatformat:2 }}"
               data-y="{{ ny|floatformat:2 }}"
               data-id="{{ m.id }}"
               data-numero="{{ m.numero }}"
               data-zona="{{ m.zona|default:'interior' }}"
               style="left: {{ nx }}%; top: {{ ny }}%;">

            <span class="mesa-badge">#{{ m.id }}</span>
            <div class="mesa-cap">{{ m.capacidad }} pax</div>

            <div class="mesa-meta">
              {% if m.zona == "terraza" %}{% trans "Terraza" %}
              {% elif m.zona == "exterior" %}{% trans "Exterior" %}
              {% else %}{% trans "Interior" %}{% endif %}
              ¬∑
              {% if m.bloqueada %}{% trans "Bloqueada" %}
              {% elif est == "DISPONIBLE" %}{% trans "Disponible" %}
              {% elif est == "RESERVADA" %}{% trans "Reservada" %}
              {% else %}{% trans "Ocupada" %}{% endif %}
            </div>

            <div class="mesa-toolbar" data-toolbar>

              <a class="btn btn-xs btn-primary"
                 href="{% url 'reservas:admin_mesa_detalle' m.id %}">{% trans "Detalle" %}</a>

              <a class="btn btn-xs btn-outline-secondary"
                 href="{% url 'reservas:admin_editar_mesa' m.id %}?next=mapa">{% trans "Editar" %}</a>

              <!-- Bot√≥n Bloquear mesa -->
              <button type="button"
                      class="btn btn-xs btn-outline-dark"
                      data-bloquear-mesa
                      data-mesa-id="{{ m.id }}"
                      data-mesa-label="#{{ m.numero }}"
                      data-bs-toggle="modal"
                      data-bs-target="#modalBloqueo">
                {% trans "Bloquear" %}
              </button>

              <button type="button"
                      class="btn btn-xs btn-success"
                      data-orden-mesa
                      data-mesa-id="{{ m.id }}"
                      data-mesa-numero="{{ m.numero }}">
                <i class="bi bi-receipt"></i> {% trans "Orden" %}
              </button>

            </div>
          </div>

        {% endwith %}
      {% endwith %}
    {% empty %}
      <div class="text-muted p-3">{% trans "No hay mesas configuradas." %}</div>
    {% endfor %}

  </div>

  <!-- Config para bloqueos.js -->
  <div id="bloqueosConfig"
       data-sucursal-id="{{ sucursal.id }}"
       data-url-create="{% url 'reservas:admin_api_bloqueo_create' %}"
       data-url-list="{% url 'reservas:admin_api_bloqueo_list' %}"
       data-url-delete="{% url 'reservas:admin_api_bloqueo_delete' %}">
  </div>

  <!-- MODAL CREAR BLOQUEO -->
  <div class="modal fade" id="modalBloqueo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{% trans "Nuevo bloqueo" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="{% trans 'Cerrar' %}"></button>
        </div>

        <div class="modal-body">
          <form id="formBloqueo">
            <input type="hidden" id="csrfToken" value="{{ csrf_token }}">

            <div class="mb-3">
              <label class="form-label">{% trans "√Åmbito" %}</label>
              <select class="form-select" data-scope>
                <option value="sucursal">{% trans "Sucursal completa" %}</option>
                <option value="mesa">{% trans "Mesa espec√≠fica" %}</option>
              </select>
            </div>

            <div class="mb-3" data-mesa-wrap style="display:none;">
              <label class="form-label">{% trans "Mesa" %}</label>
              <select class="form-select" data-mesa-id>
                <option value="">{% trans "Selecciona una mesa" %}</option>
                {% for item in estado_mesas %}
                  {% with m=item.mesa %}
                    <option value="{{ m.id }}">#{{ m.numero }} ({{ m.capacidad }} pax)</option>
                  {% endwith %}
                {% endfor %}
              </select>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">{% trans "Inicio" %}</label>
                <input type="datetime-local" name="inicio" class="form-control">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">{% trans "Fin" %}</label>
                <input type="datetime-local" name="fin" class="form-control">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">{% trans "Motivo (opcional)" %}</label>
              <input type="text" name="motivo" class="form-control">
            </div>

            <div class="alert alert-danger d-none" data-error></div>
            <div class="alert alert-success d-none" data-success>
              {% trans "Bloqueo creado correctamente." %}
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {% trans "Cerrar" %}
          </button>
          <button type="button" class="btn btn-primary" data-action="crear-bloqueo">
            {% trans "Guardar bloqueo" %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL LISTA BLOQUEOS -->
  <div class="modal fade" id="modalBloqueosLista" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{% trans "Bloqueos de la sucursal" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="{% trans 'Cerrar' %}"></button>
        </div>

        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">{% trans "Filtrar por mesa" %}</label>
              <select class="form-select" data-filtro-mesa>
                <option value="">{% trans "Todas las mesas" %}</option>
                {% for item in estado_mesas %}
                  {% with m=item.mesa %}
                    <option value="{{ m.id }}">#{{ m.numero }} ({{ m.capacidad }} pax)</option>
                  {% endwith %}
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="alert alert-info d-none" data-empty>
            {% trans "No hay bloqueos vigentes." %}
          </div>
          <div class="alert alert-danger d-none" data-error-list>
            {% trans "Ocurri√≥ un error al cargar los bloqueos." %}
          </div>

          <div class="table-responsive" data-tabla-bloqueos>
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>{% trans "√Åmbito" %}</th>
                  <th>{% trans "Mesa" %}</th>
                  <th>{% trans "Inicio" %}</th>
                  <th>{% trans "Fin" %}</th>
                  <th>{% trans "Motivo" %}</th>
                  <th class="text-end">{% trans "Acciones" %}</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Orden (POS nuevo) -->
  <div class="modal fade" id="modalOrden" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content" id="ordenContenido">
        {# contenido del POS se inyecta por AJAX #}
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  window.MAPA_CONFIG = {
    sucursalId: {{ sucursal.id }},
    apiListUrl: "{{ api_list_url }}",
    apiSavePosUrl: "{{ api_save_url }}"
  };

  window.ORDENES_CONFIG = {
    urlNuevaOrden: "{% url 'reservas:orden_mesa_nueva' %}",
    csrfToken: "{{ csrf_token }}",
    texto: {
      cargando: "{% trans 'Cargando orden...' %}",
      error: "{% trans 'Error al cargar la orden.' %}"
    }
  };
</script>

<script id="mesas-data" type="application/json">{{ mesas_json }}</script>

<script src="{% static 'reservas/js/mapa.js' %}?v=20251119"></script>
<script src="{% static 'reservas/js/bloqueos.js' %}?v=20251119"></script>
<script src="{% static 'reservas/js/ordenes.js' %}?v=20251119"></script>
{% endblock %}
