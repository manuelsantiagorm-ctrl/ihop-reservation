{% extends "base.html" %}
{% load i18n static reservas_time %}

{% block title %}{% trans "Mis reservaciones" %} · IHOP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'reservas/css/mis_reservas.css' %}">
{% endblock %}

{% block content %}
<div class="myr-container">

  <div class="myr-header">
    <div>
      <h1 class="myr-title">{% trans "Mis reservas" %}</h1>
      <p class="myr-subtitle text-muted">{% trans "Aquí puedes ver tu próxima reservación y el historial reciente." %}</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'reservas:perfil' %}">
        <i class="bi bi-person-circle me-1"></i>{% trans "Perfil" %}
      </a>
      <a class="btn btn-primary" href="{% url 'reservas:seleccionar_sucursal' %}">
        <i class="bi bi-plus-circle me-1"></i>{% trans "Nueva reserva" %}
      </a>
    </div>
  </div>

  {% if reserva_activa %}
  <!-- Reserva activa -->
  <section class="myr-section">
    <div class="myr-card myr-card--active">
      <div class="myr-card-head">
        <div class="d-flex align-items-center gap-2">
          <span class="badge myr-badge myr-badge--{{ reserva_activa.estado|lower }}">
            {% if reserva_activa.estado == "CONF" %}{% trans "Confirmada" %}
            {% elif reserva_activa.estado == "PEND" %}{% trans "Pendiente" %}
            {% elif reserva_activa.estado == "CANC" %}{% trans "Cancelada" %}{% else %}
            {{ reserva_activa.get_estado_display }}{% endif %}
          </span>
          <span class="myr-pill">
            {% trans "Folio" %}: <strong id="folio-activo">{{ reserva_activa.folio }}</strong>
          </span>
          <button class="btn btn-sm btn-outline-secondary myr-copy"
                  data-copy-target="#folio-activo">
            <i class="bi bi-clipboard"></i> {% trans "Copiar folio" %}
          </button>
        </div>
      </div>

      <div class="myr-card-body">
        <div class="row g-3">
          <div class="col-md-7">
            <h3 class="myr-bigtime mb-2">
              {% if reserva_activa.inicio_utc %}
                {{ reserva_activa.inicio_utc|as_local:reserva_activa.mesa.sucursal|date:"d \\d\\e F Y, H:i" }}
              {% else %}
                {{ reserva_activa.fecha|date:"d \\d\\e F Y, H:i" }}
              {% endif %}
            </h3>
            <div class="myr-meta">
              <div><i class="bi bi-geo-alt"></i> {{ reserva_activa.mesa.sucursal.nombre }}</div>
              <div><i class="bi bi-grid-3x3-gap"></i> {% trans "Mesa" %} {{ reserva_activa.mesa.numero }}</div>
              <div><i class="bi bi-people"></i> {{ reserva_activa.num_personas }}
                {% blocktrans count n=reserva_activa.num_personas %}persona{% plural %}personas{% endblocktrans %}
              </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="myr-box">
              <div class="myr-box-row"><span>{% trans "Sucursal" %}</span><b>{{ reserva_activa.mesa.sucursal.nombre }}</b></div>
              <div class="myr-box-row"><span>{% trans "Estado" %}</span>
                <b>
                  {% if reserva_activa.estado == "CONF" %}{% trans "Confirmada" %}
                  {% elif reserva_activa.estado == "PEND" %}{% trans "Pendiente" %}
                  {% else %}{{ reserva_activa.get_estado_display }}{% endif %}
                </b>
              </div>
              <div class="myr-box-row"><span>{% trans "Folio" %}</span><b>{{ reserva_activa.folio }}</b></div>
            </div>
          </div>
        </div>

        <div class="mt-3 d-flex flex-wrap gap-2">
          <a class="btn btn-outline-primary" href="{% url 'reservas:seleccionar_sucursal' %}">
            <i class="bi bi-calendar2-plus me-1"></i> {% trans "Reservar otra mesa" %}
          </a>
          <a class="btn btn-outline-dark" href="{% url 'reservas:sucursal_detalle' reserva_activa.mesa.sucursal.slug %}">
            <i class="bi bi-geo me-1"></i> {% trans "Ver sucursal" %}
          </a>
        </div>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Historial -->
  <section class="myr-section">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="myr-h2">{% trans "Reservaciones pasadas" %}</h2>
      {% if reservas_pasadas %}
      <div class="myr-search-wrap">
        <i class="bi bi-search"></i>
        <input id="myr-search" class="form-control form-control-sm" type="search"
               placeholder="{% trans 'Buscar por folio, sucursal o mesa…' %}">
      </div>
      {% endif %}
    </div>

    {% if reservas_pasadas %}
      <div class="table-responsive myr-table-wrap">
        <table class="table align-middle myr-table" id="tabla-pasadas">
          <thead>
            <tr>
              <th>{% trans "Fecha y hora" %}</th>
              <th>{% trans "Sucursal / Mesa" %}</th>
              <th class="text-center">{% trans "Personas" %}</th>
              <th class="text-center">{% trans "Estado" %}</th>
              <th class="text-nowrap">{% trans "Folio" %}</th>
              <th style="width:1%"></th>
            </tr>
          </thead>
          <tbody>
            {% for r in reservas_pasadas %}
            <tr>
              <td class="text-nowrap">
                {% if r.inicio_utc %}
                  {{ r.inicio_utc|as_local:r.mesa.sucursal|date:"d/m/Y H:i" }}
                {% else %}
                  {{ r.fecha|date:"d/m/Y H:i" }}
                {% endif %}
              </td>
              <td>
                <div class="fw-semibold">{{ r.mesa.sucursal.nombre }}</div>
                <div class="text-muted small">{% trans "Mesa" %} {{ r.mesa.numero }}</div>
              </td>
              <td class="text-center">{{ r.num_personas }}</td>
              <td class="text-center">
                <span class="badge myr-badge myr-badge--{{ r.estado|lower }}">
                  {% if r.estado == "CANC" %}{% trans "Cancelada" %}
                  {% elif r.estado == "CONF" and r.fecha < ahora %}{% trans "Finalizada" %}
                  {% elif r.estado == "CONF" %}{% trans "Confirmada" %}
                  {% elif r.estado == "PEND" %}{% trans "Pendiente" %}
                  {% else %}{{ r.get_estado_display }}{% endif %}
                </span>
              </td>
              <td class="text-nowrap"><code id="folio-{{ r.id }}">{{ r.folio }}</code></td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-secondary myr-copy"
                        data-copy-target="#folio-{{ r.id }}">
                  <i class="bi bi-clipboard"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p class="text-muted small mt-2 mb-0">
          {% trans "Mostrando tus últimas 3 reservaciones." %}
        </p>
      </div>
    {% else %}
      <div class="myr-empty">
        <i class="bi bi-journal-x"></i>
        <p class="mb-1 fw-semibold">{% trans "Aún no tienes reservaciones pasadas." %}</p>
        <a class="btn btn-primary" href="{% url 'reservas:seleccionar_sucursal' %}">
          {% trans "Reservar ahora" %}
        </a>
      </div>
    {% endif %}
  </section>
</div>

<!-- Toast mínimal para “Copiado” -->
<div class="toast align-items-center myr-toast" id="toast-copiado" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body">
      <i class="bi bi-clipboard-check me-1"></i> {% trans "Folio copiado al portapapeles" %}
    </div>
    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Cerrar' %}"></button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'reservas/js/mis_reservas.js' %}"></script>
{% endblock %}
