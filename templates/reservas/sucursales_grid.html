{% load static i18n %}
{% extends "base.html" %}
{% block title %}{% trans "Sucursales" %}{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="d-flex align-items-center justify-content-between mb-2">
    <h1 class="h4 m-0">{% trans "Descubre y reserva" %}</h1>
    <form class="d-flex" method="get" action=".">
      <input type="search" name="q" value="{{ q }}" class="form-control me-2"
             placeholder="{% trans 'Buscar por nombre o ciudad' %}">
      <button class="btn btn-primary">{% trans "Buscar" %}</button>
    </form>
  </div>

  <!-- Carrusel horizontal tipo OpenTable -->
  <h2 class="h6 text-muted mb-2">{% trans "Disponibles para la hora de la comida ahora" %}</h2>
  <div class="position-relative">
    <button class="btn btn-light shadow-sm carousel-btn prev" type="button" aria-label="prev">‹</button>
    <div id="strip" class="strip scroll-snap-x">
      {% for s in sucursales %}
      <a class="card card-ot me-3 text-decoration-none" href="{% url 'reservas:seleccionar_sucursal' %}?id={{ s.id }}">
        <div class="ratio ratio-16x9 card-img-top overflow-hidden">
          {% if s.portada %}
            <img src="{{ s.portada.url }}" class="w-100 h-100 object-fit-cover" alt="{{ s.nombre }}">
          {% else %}
            <img src="{% static 'img/placeholder-restaurant.jpg' %}" class="w-100 h-100 object-fit-cover" alt="placeholder">
          {% endif %}
        </div>
        <div class="card-body p-2">
          <div class="d-flex align-items-center small text-muted mb-1">
            <span class="me-1">⭐</span>
            <strong class="me-1">{{ s.rating|default:"4.7" }}</strong>
            <span class="text-muted">· {{ s.precio_signos|default:"$$" }} · {{ s.ciudad }}</span>
          </div>
          <h3 class="h6 text-dark m-0 mb-1">{{ s.nombre }}</h3>
          <div class="small text-muted mb-2">
            {% blocktrans with n=s.reservas_hoy|default:0 %}Reservado {{ n }} veces hoy{% endblocktrans %}
          </div>

          <div class="d-flex gap-2 flex-wrap">
            {% for h in s.sugerencias_hoy|default_if_none:""|slice:":3" %}
              <span class="btn btn-sm btn-outline-danger">{{ h }}</span>
            {% empty %}
              <span class="btn btn-sm btn-outline-secondary disabled">{% trans "Sin horarios" %}</span>
            {% endfor %}
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
    <button class="btn btn-light shadow-sm carousel-btn next" type="button" aria-label="next">›</button>
  </div>

  <!-- Grilla completa abajo -->
  <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
    <h2 class="h6 text-muted m-0">{% trans "Todas las sucursales" %}</h2>
    <a class="small" href="#top">{% trans "Volver arriba" %}</a>
  </div>

  <div class="row g-3">
    {% for s in sucursales %}
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <a class="card h-100 text-decoration-none card-ot" href="{% url 'reservas:seleccionar_sucursal' %}?id={{ s.id }}">
        <div class="ratio ratio-16x9 overflow-hidden rounded-top">
          {% if s.portada %}
            <img src="{{ s.portada.url }}" class="w-100 h-100 object-fit-cover" alt="{{ s.nombre }}">
          {% else %}
            <img src="{% static 'img/placeholder-restaurant.jpg' %}" class="w-100 h-100 object-fit-cover" alt="placeholder">
          {% endif %}
        </div>
        <div class="card-body p-3">
          <div class="small text-muted mb-1">⭐ <strong>{{ s.rating|default:"4.7" }}</strong> · {{ s.precio_signos|default:"$$" }} · {{ s.ciudad }}</div>
          <h3 class="h6 text-dark m-0">{{ s.nombre }}</h3>
        </div>
      </a>
    </div>
    {% endfor %}
  </div>
</div>

<style>
  .ratio-16x9 { aspect-ratio: 16/9; }
  .object-fit-cover { object-fit: cover; }
  .card-ot { border: 1px solid #eee; border-radius: 12px; transition: transform .15s ease, box-shadow .15s ease; }
  .card-ot:hover { transform: translateY(-2px); box-shadow: 0 6px 22px rgba(0,0,0,.08); }
  .strip { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(260px, 280px); overflow-x: auto; padding: .25rem; scroll-behavior: smooth; gap: .5rem; }
  .scroll-snap-x { scroll-snap-type: x mandatory; }
  .strip > * { scroll-snap-align: start; }
  .carousel-btn { position: absolute; top: 40%; z-index: 2; width: 36px; height: 36px; border-radius: 999px; }
  .carousel-btn.prev { left: -10px; }
  .carousel-btn.next { right: -10px; }
  @media (max-width: 576px) {
    .carousel-btn { display:none; }
  }
</style>

<script>
(function () {
  const strip = document.getElementById("strip");
  if (!strip) return;
  const prev = document.querySelector(".carousel-btn.prev");
  const next = document.querySelector(".carousel-btn.next");
  const step = 300;
  prev?.addEventListener("click", () => strip.scrollBy({left: -step, behavior: "smooth"}));
  next?.addEventListener("click", () => strip.scrollBy({left: step, behavior: "smooth"}));
})();
</script>
{% endblock %}
